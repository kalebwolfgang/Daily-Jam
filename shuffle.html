<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Daily Jam — Shuffle</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;0,900;1,700&family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0e0c0f; --surface: #161418; --surface2: #1e1b21; --border: #272330;
    --amber: #9b6dff; --amber-glow: rgba(155,109,255,0.12);
    --text: #e8e0d0; --text-dim: #7a7060; --text-muted: #3a3530;
    --y1:#5d8fe8; --y2:#5dba7f; --y3:#e85d8f; --y4:#e8a45d;
    --y5:#a45de8; --y6:#5de8e8; --y7:#e8e85d; --y8:#FF6B6B;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: #0a0810; color: var(--text); font-family: 'Space Mono', monospace; min-height: 100vh; overflow-x: hidden; }
  body::before { content: ''; position: fixed; inset: 0; pointer-events: none; z-index: 0;
    background:
      radial-gradient(ellipse 80% 60% at 10% 0%,   rgba(155,109,255,0.16) 0%, transparent 60%),
      radial-gradient(ellipse 60% 50% at 90% 100%,  rgba(93,143,232,0.12)  0%, transparent 55%),
      radial-gradient(ellipse 50% 40% at 85% 8%,    rgba(232,93,143,0.08)  0%, transparent 50%),
      radial-gradient(ellipse 40% 35% at 5%  90%,   rgba(93,186,127,0.08)  0%, transparent 50%); }
  body::after  { content: ''; position: fixed; inset: 0; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E"); pointer-events: none; z-index: 9999; opacity: 0.4; }

  /* NAV */
  .site-nav { position: sticky; top: 0; z-index: 100; display: flex; align-items: center; justify-content: space-between; padding: 0 40px; height: 56px; background: rgba(14,12,15,0.95); border-bottom: 1px solid var(--border); backdrop-filter: blur(8px); }
  .site-logo { font-family: 'Space Mono', monospace; font-size: 16px; font-weight: 700; color: var(--text); text-decoration: none; letter-spacing: 1px; }
  .site-logo span { color: var(--amber); font-style: italic; }
  .nav-links { display: flex; gap: 4px; }
  .nav-link { font-size: 11px; letter-spacing: 2px; text-transform: uppercase; color: var(--text-dim); text-decoration: none; padding: 8px 14px; transition: color 0.15s; }
  .nav-link:hover { color: var(--text); }
  .nav-link.active { color: var(--amber); }

  /* PAGE HEADER */
  .page-header { padding: 40px 40px 0; border-bottom: 1px solid var(--border); }
  .page-header h1 { font-family: 'Playfair Display', serif; font-size: clamp(36px, 5vw, 64px); font-weight: 900; line-height: 0.9; letter-spacing: -2px; margin-bottom: 12px; }
  .page-header h1 span { color: var(--amber); font-style: italic; }
  .page-header p { font-size: 11px; color: var(--text-dim); letter-spacing: 3px; text-transform: uppercase; margin-bottom: 24px; }

  /* YEAR FILTER */
  .year-filter { display: flex; gap: 0; flex-wrap: wrap; padding-top: 2px; }
  .yf-btn { padding: 12px 18px; font-family: 'Space Mono', monospace; font-size: 11px; font-weight: 700; letter-spacing: 1px; color: var(--text-muted); background: transparent; border: none; border-bottom: 3px solid transparent; cursor: pointer; transition: all 0.15s; position: relative; top: 1px; white-space: nowrap; }
  .yf-btn:hover { color: var(--text); }
  .yf-btn.active { border-bottom-color: currentColor; }
  .yf-btn.all { color: var(--amber); }
  .yf-btn.y1 { color: var(--y1); } .yf-btn.y2 { color: var(--y2); } .yf-btn.y3 { color: var(--y3); }
  .yf-btn.y4 { color: var(--y4); } .yf-btn.y5 { color: var(--y5); } .yf-btn.y6 { color: var(--y6); }
  .yf-btn.y7 { color: var(--y7); } .yf-btn.y8 { color: var(--y8); }

  /* MAIN AREA */
  .shuffle-area { padding: 48px 40px 80px; max-width: 1280px; margin: 0 auto; }

  /* REELS ROW */
  .reels-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; max-width: 1200px; margin: 0 auto 40px; }

  /* SINGLE REEL CARD */
  .reel-card {
    background: var(--surface);
    border: 2px solid var(--border);
    cursor: default;
    position: relative;
    overflow: hidden;
    transition: border-color 0.2s, box-shadow 0.2s, transform 0.15s;
    display: flex;
    flex-direction: column;
    min-height: 280px;
  }
  .reel-card.has-song { cursor: pointer; }
  .reel-card.has-song:hover { border-color: var(--reel-color, var(--amber)); box-shadow: 0 0 0 1px var(--reel-color, var(--amber)); transform: translateY(-3px); }
  .reel-card.selected { border-color: var(--reel-color, var(--amber)); box-shadow: 0 0 32px var(--reel-glow, var(--amber-glow)); }
  .reel-card.selected .reel-select-hint { opacity: 0; }
  .reel-card.dimmed { opacity: 0.3; transform: scale(0.96); }

  .reel-top-bar { height: 4px; width: 100%; background: var(--border); transition: background 0.3s; }
  .reel-card.has-song .reel-top-bar { background: var(--reel-color, var(--border)); }

  .reel-body { padding: 28px 24px 24px; flex: 1; display: flex; flex-direction: column; }

  .reel-num { font-size: 10px; letter-spacing: 2px; text-transform: uppercase; color: var(--text-dim); margin-bottom: 16px; }

  /* slot scroll window */
  .reel-window { height: 150px; overflow: hidden; position: relative; margin-bottom: 18px; }
  .reel-tape { position: absolute; left: 0; right: 0; top: 0; transition: none; }
  .reel-tape-item { height: 50px; display: flex; align-items: center; font-family: 'Playfair Display', serif; font-size: 17px; font-weight: 700; color: var(--text-dim); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding: 0 2px; }
  .reel-tape-item.center { font-size: 20px; color: var(--text); }

  /* gradient masks on window */
  .reel-window::before, .reel-window::after {
    content: ''; position: absolute; left: 0; right: 0; z-index: 2; pointer-events: none;
  }
  .reel-window::before { top: 0; height: 44px; background: linear-gradient(to bottom, var(--surface), transparent); }
  .reel-window::after  { bottom: 0; height: 44px; background: linear-gradient(to top, var(--surface), transparent); }

  .reel-artist { font-size: 13px; color: var(--reel-color, var(--amber)); margin-bottom: 5px; transition: color 0.3s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 700; }
  .reel-album  { font-size: 12px; color: var(--text-dim); margin-bottom: 18px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

  .reel-footer { display: flex; align-items: center; justify-content: space-between; gap: 8px; flex-wrap: wrap; margin-top: auto; }
  .reel-meta { font-size: 11px; color: var(--text-dim); letter-spacing: 1px; }
  .year-pill { display: inline-block; padding: 2px 7px; font-size: 9px; font-weight: 700; letter-spacing: 1px; border: 1px solid; }
  .year-pill.y1 { border-color: var(--y1); color: var(--y1); } .year-pill.y2 { border-color: var(--y2); color: var(--y2); }
  .year-pill.y3 { border-color: var(--y3); color: var(--y3); } .year-pill.y4 { border-color: var(--y4); color: var(--y4); }
  .year-pill.y5 { border-color: var(--y5); color: var(--y5); } .year-pill.y6 { border-color: var(--y6); color: var(--y6); }
  .year-pill.y7 { border-color: var(--y7); color: var(--y7); } .year-pill.y8 { border-color: var(--y8); color: var(--y8); }

  .reel-select-hint { font-size: 10px; letter-spacing: 1px; text-transform: uppercase; color: var(--text-dim); transition: opacity 0.2s; }
  .reel-card.has-song:hover .reel-select-hint { color: var(--reel-color, var(--amber)); }

  /* placeholder state */
  .reel-card.placeholder .reel-tape-item { color: var(--text-dim); }
  .reel-card.placeholder .reel-artist,
  .reel-card.placeholder .reel-album,
  .reel-card.placeholder .reel-meta { color: var(--text-dim); }

  /* SELECTED SONG PANEL */
  .selected-panel { max-width: 1200px; margin: 0 auto; background: var(--surface); border: 1px solid var(--border); display: none; }
  .selected-panel.visible { display: block; }
  .selected-panel-bar { height: 3px; background: var(--selected-color, var(--amber)); }
  .selected-panel-inner { padding: 20px 24px; display: flex; align-items: center; gap: 24px; flex-wrap: wrap; }
  .selected-label { font-size: 9px; letter-spacing: 2px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 4px; }
  .selected-song { font-family: 'Playfair Display', serif; font-size: 20px; font-weight: 700; color: var(--text); }
  .selected-sub { font-size: 12px; color: var(--selected-color, var(--amber)); margin-top: 3px; }
  .btn-spotify { display: inline-flex; align-items: center; gap: 8px; background: #1DB954; color: #000; font-family: 'Space Mono', monospace; font-size: 12px; font-weight: 700; padding: 10px 18px; text-decoration: none; letter-spacing: 1px; transition: opacity 0.15s; white-space: nowrap; }
  .btn-spotify:hover { opacity: 0.85; }
  .selected-info { flex: 1; min-width: 0; }

  /* CONTROLS */
  .controls { max-width: 1200px; margin: 28px auto 0; display: flex; align-items: center; gap: 20px; flex-wrap: wrap; }
  .shuffle-btn { font-family: 'Space Mono', monospace; font-size: 13px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; background: var(--amber); color: var(--bg); border: none; padding: 14px 40px; cursor: pointer; transition: opacity 0.15s, transform 0.1s; }
  .shuffle-btn:hover { opacity: 0.88; }
  .shuffle-btn:active { transform: scale(0.97); }
  .shuffle-btn:disabled { opacity: 0.4; cursor: default; }
  .pool-info { font-size: 11px; color: var(--text-muted); letter-spacing: 1px; }

  @media (max-width: 800px) {
    .reels-row { grid-template-columns: 1fr; gap: 8px; }
    .site-nav { padding: 0 16px; } .nav-link { padding: 8px 8px; font-size: 10px; }
    .page-header { padding: 32px 16px 0; }
    .shuffle-area { padding: 32px 16px 60px; }
    .reel-body { padding: 18px 16px 16px; }
  }
</style>
</head>
<body>

<nav class="site-nav">
  <a class="site-logo" href="index.html">Daily <span>Jam</span></a>
  <div class="nav-links">
    <a class="nav-link" href="index.html">Home</a>
    <a class="nav-link" href="catalog.html">Catalog</a>
    <a class="nav-link" href="calendar.html">Calendar</a>
    <a class="nav-link" href="stats.html">Stats</a>
    <a class="nav-link active" href="shuffle.html">Shuffle</a>
  </div>
</nav>

<div class="page-header">
  <h1>Shuf<span>fle</span></h1>
  <p>Roll 3 songs — pick one to play</p>
  <div class="year-filter">
    <button class="yf-btn all active" data-year="0">All Years</button>
    <button class="yf-btn y1" data-year="1">DJ 1</button>
    <button class="yf-btn y2" data-year="2">DJ 2</button>
    <button class="yf-btn y3" data-year="3">DJ 3</button>
    <button class="yf-btn y4" data-year="4">DJ 4</button>
    <button class="yf-btn y5" data-year="5">DJ 5</button>
    <button class="yf-btn y6" data-year="6">DJ 6</button>
    <button class="yf-btn y7" data-year="7">DJ 7</button>
    <button class="yf-btn y8" data-year="8">DJ 8</button>
  </div>
</div>

<div class="shuffle-area">

  <div class="reels-row" id="reels-row">
    <!-- Reel 1 -->
    <div class="reel-card placeholder" id="reel-0">
      <div class="reel-top-bar"></div>
      <div class="reel-body">
        <div class="reel-num">Reel 1</div>
        <div class="reel-window">
          <div class="reel-tape" id="tape-0">
            <div class="reel-tape-item">—</div>
            <div class="reel-tape-item center">Hit Shuffle</div>
            <div class="reel-tape-item">—</div>
          </div>
        </div>
        <div class="reel-artist" id="artist-0">—</div>
        <div class="reel-album"  id="album-0">—</div>
        <div class="reel-footer">
          <div class="reel-meta" id="meta-0">—</div>
          <div class="reel-select-hint" id="hint-0"></div>
        </div>
      </div>
    </div>
    <!-- Reel 2 -->
    <div class="reel-card placeholder" id="reel-1">
      <div class="reel-top-bar"></div>
      <div class="reel-body">
        <div class="reel-num">Reel 2</div>
        <div class="reel-window">
          <div class="reel-tape" id="tape-1">
            <div class="reel-tape-item">—</div>
            <div class="reel-tape-item center">to begin</div>
            <div class="reel-tape-item">—</div>
          </div>
        </div>
        <div class="reel-artist" id="artist-1">—</div>
        <div class="reel-album"  id="album-1">—</div>
        <div class="reel-footer">
          <div class="reel-meta" id="meta-1">—</div>
          <div class="reel-select-hint" id="hint-1"></div>
        </div>
      </div>
    </div>
    <!-- Reel 3 -->
    <div class="reel-card placeholder" id="reel-2">
      <div class="reel-top-bar"></div>
      <div class="reel-body">
        <div class="reel-num">Reel 3</div>
        <div class="reel-window">
          <div class="reel-tape" id="tape-2">
            <div class="reel-tape-item">—</div>
            <div class="reel-tape-item center">↓</div>
            <div class="reel-tape-item">—</div>
          </div>
        </div>
        <div class="reel-artist" id="artist-2">—</div>
        <div class="reel-album"  id="album-2">—</div>
        <div class="reel-footer">
          <div class="reel-meta" id="meta-2">—</div>
          <div class="reel-select-hint" id="hint-2"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Selected song panel (appears after picking) -->
  <div class="selected-panel" id="selected-panel">
    <div class="selected-panel-bar" id="selected-bar"></div>
    <div class="selected-panel-inner">
      <div class="selected-info">
        <div class="selected-label">Your Pick</div>
        <div class="selected-song" id="selected-song-name"></div>
        <div class="selected-sub" id="selected-song-sub"></div>
      </div>
      <a class="btn-spotify" id="btn-spotify" href="#" target="_blank">▶ Open in Spotify</a>
    </div>
  </div>

  <div class="controls">
    <button class="shuffle-btn" id="shuffle-btn" disabled>Loading…</button>
    <div class="pool-info" id="pool-info"></div>
  </div>

</div>

<script>
const YEAR_COLORS = ['','#5d8fe8','#5dba7f','#e85d8f','#e8a45d','#a45de8','#5de8e8','#e8e85d','#FF6B6B'];
const YEAR_GLOWS  = ['','rgba(93,143,232,0.15)','rgba(93,186,127,0.15)','rgba(232,93,143,0.15)','rgba(232,164,93,0.15)','rgba(164,93,232,0.15)','rgba(93,232,232,0.15)','rgba(232,232,93,0.15)','rgba(255,107,107,0.15)'];
const YEAR_LABELS = ['','2018–19','2019–20','2020–21','2021–22','2022–23','2023–24','2024–25','2025–26'];

function getDailyJamYear(dayNum) {
  const daysInYears = [365, 366, 365, 365, 365, 366, 365, 365];
  let total = 0;
  for (let i = 0; i < daysInYears.length; i++) {
    total += daysInYears[i];
    if (dayNum <= total) return i + 1;
  }
  return 8;
}

let SONGS = [];
let pool = [];
let filterYear = 0;
let spinning = false;
let finalSongs = [null, null, null];
let selectedReel = -1;

function getPool() {
  return filterYear === 0 ? SONGS : SONGS.filter(s => getDailyJamYear(s[0]) === filterYear);
}

function updatePoolInfo() {
  pool = getPool();
  const label = filterYear === 0 ? 'All Years' : `DJ ${filterYear} (${YEAR_LABELS[filterYear]})`;
  document.getElementById('pool-info').textContent = `${pool.length.toLocaleString()} songs in pool`;
}

// Build a tape of song titles for the scroll animation
function buildTape(songs, centerIndex) {
  // center item is at index 1 in a 3-item tape; build longer tape around it
  const items = [];
  for (let i = -4; i <= 4; i++) {
    const idx = (centerIndex + i + songs.length) % songs.length;
    items.push(songs[idx][2]);
  }
  return items; // 9 items, center is index 4
}

// Animate one reel scrolling: rapidly cycle through songs, then ease into final
function spinReel(reelIndex, songPool, delay, finalSong) {
  return new Promise(resolve => {
    setTimeout(() => {
      const tape = document.getElementById(`tape-${reelIndex}`);
      const card = document.getElementById(`reel-${reelIndex}`);
      const ITEM_H = 50;

      // Generate a long random tape, with finalSong at position -1 from end
      const count = 30 + Math.floor(Math.random() * 10);
      let items = [];
      for (let i = 0; i < count; i++) {
        items.push(songPool[Math.floor(Math.random() * songPool.length)]);
      }
      // Put the final song at position count-2 (so center lands on it)
      items[count - 2] = finalSong;

      // Build DOM
      tape.innerHTML = '';
      items.forEach((s, i) => {
        const div = document.createElement('div');
        div.className = 'reel-tape-item' + (i === count - 2 ? ' center' : '');
        div.textContent = s[2];
        tape.appendChild(div);
      });

      // Start at top
      tape.style.transition = 'none';
      tape.style.transform = 'translateY(0)';

      // The center of the window is at 40px (items 0,1,2 visible; item 1 is center)
      // We want item (count-2) to be in center = offset = (count-2 - 1) * 40 = (count-3)*40
      const targetOffset = (count - 3) * ITEM_H;

      // Animate via requestAnimationFrame with easing
      const duration = 900 + delay * 0.5;
      const startTime = performance.now();

      function easeOut(t) {
        return 1 - Math.pow(1 - t, 3);
      }

      function frame(now) {
        const elapsed = now - startTime;
        const t = Math.min(elapsed / duration, 1);
        const eased = easeOut(t);
        const currentY = -(eased * targetOffset);
        tape.style.transform = `translateY(${currentY}px)`;

        if (t < 1) {
          requestAnimationFrame(frame);
        } else {
          tape.style.transform = `translateY(-${targetOffset}px)`;
          // Settle bounce
          card.style.transition = 'transform 0.25s cubic-bezier(.34,1.56,.64,1)';
          card.style.transform = 'translateY(-4px)';
          setTimeout(() => {
            card.style.transform = '';
            resolve();
          }, 250);
        }
      }
      requestAnimationFrame(frame);
    }, delay);
  });
}

function setReelSong(i, song) {
  const yr = getDailyJamYear(song[0]);
  const color = YEAR_COLORS[yr];
  const glow  = YEAR_GLOWS[yr];
  const card  = document.getElementById(`reel-${i}`);

  card.style.setProperty('--reel-color', color);
  card.style.setProperty('--reel-glow', glow);
  card.classList.remove('placeholder');
  card.classList.add('has-song');

  document.getElementById(`artist-${i}`).textContent = song[3];
  document.getElementById(`album-${i}`).textContent  = song[4];
  document.getElementById(`meta-${i}`).textContent   = `Day ${song[0].toLocaleString()} · ${song[5]}`;
  document.getElementById(`hint-${i}`).textContent   = 'Click to pick →';

  // set year pill on top bar (reuse card's top bar color)
  card.querySelector('.reel-top-bar').style.background = color;
}

function clearSelection() {
  for (let i = 0; i < 3; i++) {
    const card = document.getElementById(`reel-${i}`);
    card.classList.remove('selected', 'dimmed');
  }
  document.getElementById('selected-panel').classList.remove('visible');
  selectedReel = -1;
}

function selectReel(i) {
  if (!finalSongs[i]) return;
  selectedReel = i;

  for (let j = 0; j < 3; j++) {
    const card = document.getElementById(`reel-${j}`);
    card.classList.remove('selected', 'dimmed');
    if (j === i) card.classList.add('selected');
    else card.classList.add('dimmed');
  }

  const song = finalSongs[i];
  const yr = getDailyJamYear(song[0]);
  const color = YEAR_COLORS[yr];

  const panel = document.getElementById('selected-panel');
  panel.style.setProperty('--selected-color', color);
  document.getElementById('selected-bar').style.background = color;
  document.getElementById('selected-song-name').textContent = song[2];
  document.getElementById('selected-song-sub').textContent  = `${song[3]} · ${song[4]} · Day ${song[0].toLocaleString()}`;
  document.getElementById('selected-song-sub').style.color  = color;
  document.getElementById('btn-spotify').href = `https://open.spotify.com/track/${song[1]}`;
  panel.classList.add('visible');
}

async function doShuffle() {
  if (spinning || pool.length < 3) return;
  spinning = true;
  clearSelection();
  finalSongs = [null, null, null];

  const btn = document.getElementById('shuffle-btn');
  btn.disabled = true;
  btn.textContent = 'Spinning…';

  // Pick 3 distinct songs
  const picked = new Set();
  while (picked.size < 3) picked.add(Math.floor(Math.random() * pool.length));
  const picks = [...picked].map(i => pool[i]);
  finalSongs = picks;

  // Reset cards to spinning state
  for (let i = 0; i < 3; i++) {
    const card = document.getElementById(`reel-${i}`);
    card.classList.remove('has-song', 'selected', 'dimmed');
    card.classList.add('placeholder');
    card.style.transform = '';
    card.style.transition = '';
    document.getElementById(`artist-${i}`).textContent = '—';
    document.getElementById(`album-${i}`).textContent  = '—';
    document.getElementById(`meta-${i}`).textContent   = '—';
    document.getElementById(`hint-${i}`).textContent   = '';
  }

  // Spin all 3 reels, staggered by 180ms each
  await Promise.all([
    spinReel(0, pool, 0,   picks[0]),
    spinReel(1, pool, 180, picks[1]),
    spinReel(2, pool, 360, picks[2]),
  ]);

  // After all settled, fill in the details
  for (let i = 0; i < 3; i++) {
    setReelSong(i, finalSongs[i]);
  }

  spinning = false;
  btn.disabled = false;
  btn.textContent = 'Shuffle Again';
}

// Reel click handlers
for (let i = 0; i < 3; i++) {
  document.getElementById(`reel-${i}`).addEventListener('click', () => {
    if (finalSongs[i]) selectReel(i);
  });
}

document.getElementById('shuffle-btn').addEventListener('click', doShuffle);

document.querySelectorAll('.yf-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    document.querySelectorAll('.yf-btn').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    filterYear = parseInt(this.dataset.year);
    updatePoolInfo();
  });
});

fetch('songs-list.json')
  .then(r => r.json())
  .then(data => {
    SONGS = data;
    updatePoolInfo();
    const btn = document.getElementById('shuffle-btn');
    btn.disabled = false;
    btn.textContent = 'Shuffle';
  });
</script>
</body>
</html>
