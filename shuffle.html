<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Daily Jam — Shuffle</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;0,900;1,700&family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a08; --surface: #111110; --surface2: #191917; --border: #242420;
    --amber: #f5a623; --amber-glow: rgba(245,166,35,0.12);
    --text: #e8e0d0; --text-dim: #7a7060; --text-muted: #3a3530;
    --y1:#5d8fe8; --y2:#5dba7f; --y3:#e85d8f; --y4:#e8a45d;
    --y5:#a45de8; --y6:#5de8e8; --y7:#e8e85d; --y8:#FF6B6B;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: #050508; color: var(--text); font-family: 'Space Mono', monospace; min-height: 100vh; overflow-x: hidden; }

  /* Neon music canvas */
  #suit-canvas { position: fixed; inset: 0; pointer-events: none; z-index: 0; }

  /* NAV */
  .site-nav { position: sticky; top: 0; z-index: 100; display: flex; align-items: center; justify-content: space-between; padding: 0 40px; height: 56px; background: rgba(5,5,8,0.97); border-bottom: 1px solid rgba(255,255,255,0.08); backdrop-filter: blur(16px); }
  .site-logo { font-family: 'Space Mono', monospace; font-size: 16px; font-weight: 700; color: var(--text); text-decoration: none; letter-spacing: 1px; }
  .site-logo span { color: var(--amber); font-style: italic; }
  .nav-links { display: flex; gap: 4px; }
  .nav-link { font-size: 11px; letter-spacing: 2px; text-transform: uppercase; color: var(--text-dim); text-decoration: none; padding: 8px 14px; transition: color 0.15s; }
  .nav-link:hover { color: var(--text); }
  .nav-link.active { color: var(--amber); }

  /* PAGE HEADER */
  .page-header { padding: 40px 40px 0; border-bottom: 1px solid rgba(255,255,255,0.06); position: relative; z-index: 1; background: rgba(5,5,8,0.6); backdrop-filter: blur(4px); }
  .page-header h1 { font-family: 'Playfair Display', serif; font-size: clamp(36px, 5vw, 64px); font-weight: 900; line-height: 0.9; letter-spacing: -2px; margin-bottom: 12px; }
  .page-header h1 span { color: var(--amber); font-style: italic; }
  .page-header p { font-size: 11px; color: var(--text-dim); letter-spacing: 3px; text-transform: uppercase; margin-bottom: 24px; }

  /* YEAR FILTER */
  .year-filter { display: flex; gap: 0; flex-wrap: wrap; padding-top: 2px; }
  .yf-btn { padding: 12px 18px; font-family: 'Space Mono', monospace; font-size: 11px; font-weight: 700; letter-spacing: 1px; color: var(--text-muted); background: transparent; border: none; border-bottom: 3px solid transparent; cursor: pointer; transition: all 0.15s; position: relative; top: 1px; white-space: nowrap; }
  .yf-btn:hover { color: var(--text); }
  .yf-btn.active { border-bottom-color: currentColor; }
  .yf-btn.all { color: var(--amber); }
  .yf-btn.y1 { color: var(--y1); } .yf-btn.y2 { color: var(--y2); } .yf-btn.y3 { color: var(--y3); }
  .yf-btn.y4 { color: var(--y4); } .yf-btn.y5 { color: var(--y5); } .yf-btn.y6 { color: var(--y6); }
  .yf-btn.y7 { color: var(--y7); } .yf-btn.y8 { color: var(--y8); }

  /* MAIN AREA */
  .shuffle-area { padding: 48px 40px 80px; max-width: 1280px; margin: 0 auto; position: relative; z-index: 1; }

  /* REELS ROW */
  .reels-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; max-width: 1200px; margin: 0 auto 40px; }

  /* SINGLE REEL CARD */
  .reel-card {
    background: rgba(10,10,14,0.82);
    border: 1px solid rgba(255,255,255,0.1);
    backdrop-filter: blur(18px);
    -webkit-backdrop-filter: blur(18px);
    cursor: default;
    position: relative;
    overflow: hidden;
    transition: border-color 0.2s, box-shadow 0.2s, transform 0.15s;
    display: flex;
    flex-direction: column;
    min-height: 280px;
  }
  .reel-card.has-song { cursor: pointer; }
  .reel-card.has-song:hover { border-color: var(--reel-color, var(--amber)); box-shadow: 0 0 0 1px var(--reel-color, var(--amber)), 0 0 24px var(--reel-color, var(--amber-glow)); transform: translateY(-3px); }
  .reel-card.selected { border-color: var(--reel-color, var(--amber)); box-shadow: 0 0 48px var(--reel-glow, var(--amber-glow)), 0 0 0 1px var(--reel-color, var(--amber)); }
  .reel-card.selected .reel-select-hint { opacity: 0; }
  .reel-card.dimmed { opacity: 0.25; transform: scale(0.96); }

  .reel-top-bar { height: 4px; width: 100%; background: var(--border); transition: background 0.3s; }
  .reel-card.has-song .reel-top-bar { background: var(--reel-color, var(--border)); }

  .reel-body { padding: 28px 24px 24px; flex: 1; display: flex; flex-direction: column; }

  .reel-num { font-size: 10px; letter-spacing: 2px; text-transform: uppercase; color: var(--text-dim); margin-bottom: 16px; }

  /* slot scroll window */
  .reel-window { height: 150px; overflow: hidden; position: relative; margin-bottom: 18px; transition: height 0.35s cubic-bezier(.4,0,.2,1); }
  .reel-window.settled { height: 50px; }
  .reel-tape { position: absolute; left: 0; right: 0; top: 0; transition: none; }
  .reel-tape-item { height: 50px; display: flex; align-items: center; font-family: 'Playfair Display', serif; font-size: 17px; font-weight: 700; color: var(--text-dim); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding: 0 2px; }
  .reel-tape-item.center { font-size: 20px; color: var(--text); }

  /* gradient masks on window — hidden once settled */
  .reel-window::before, .reel-window::after {
    content: ''; position: absolute; left: 0; right: 0; z-index: 2; pointer-events: none; transition: opacity 0.3s;
  }
  .reel-window::before { top: 0; height: 44px; background: linear-gradient(to bottom, var(--surface), transparent); }
  .reel-window::after  { bottom: 0; height: 44px; background: linear-gradient(to top, var(--surface), transparent); }
  .reel-window.settled::before, .reel-window.settled::after { opacity: 0; }

  .reel-artist { font-size: 18px; color: var(--reel-color, var(--amber)); margin-bottom: 6px; transition: color 0.3s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 700; }
  .reel-album  { font-size: 13px; color: var(--text-dim); margin-bottom: 18px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

  .reel-footer { display: flex; align-items: center; justify-content: space-between; gap: 8px; flex-wrap: wrap; margin-top: auto; }
  .reel-meta { font-size: 14px; color: var(--text-dim); letter-spacing: 1px; }
  .year-pill { display: inline-block; padding: 2px 7px; font-size: 9px; font-weight: 700; letter-spacing: 1px; border: 1px solid; }
  .year-pill.y1 { border-color: var(--y1); color: var(--y1); } .year-pill.y2 { border-color: var(--y2); color: var(--y2); }
  .year-pill.y3 { border-color: var(--y3); color: var(--y3); } .year-pill.y4 { border-color: var(--y4); color: var(--y4); }
  .year-pill.y5 { border-color: var(--y5); color: var(--y5); } .year-pill.y6 { border-color: var(--y6); color: var(--y6); }
  .year-pill.y7 { border-color: var(--y7); color: var(--y7); } .year-pill.y8 { border-color: var(--y8); color: var(--y8); }

  .reel-select-hint { font-size: 14px; letter-spacing: 1px; text-transform: uppercase; color: var(--text-dim); transition: opacity 0.2s; font-weight: 700; }
  .reel-card.has-song:hover .reel-select-hint { color: var(--reel-color, var(--amber)); }

  /* placeholder state */
  .reel-card.placeholder .reel-tape-item { color: var(--text-dim); }
  .reel-card.placeholder .reel-artist,
  .reel-card.placeholder .reel-album,
  .reel-card.placeholder .reel-meta { color: var(--text-dim); }

  /* REVEAL PANEL — replaces reels after picking */
  .reveal-panel { max-width: 1200px; margin: 0 auto; display: none; }
  .reveal-panel.visible { display: block; }
  .reveal-card {
    background: rgba(8,8,14,0.88); border: 1px solid var(--reveal-color, var(--amber));
    backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
    box-shadow: 0 0 60px var(--reveal-glow, var(--amber-glow)), 0 0 0 1px var(--reveal-color, var(--amber));
    padding: 0;
    animation: revealIn 0.4s cubic-bezier(.34,1.56,.64,1);
  }
  @keyframes revealIn {
    from { opacity: 0; transform: scale(0.94) translateY(12px); }
    to   { opacity: 1; transform: scale(1) translateY(0); }
  }
  .reveal-top-bar { height: 4px; background: var(--reveal-color, var(--amber)); }
  .reveal-body { padding: 48px 52px; }
  .reveal-eyebrow { font-size: 10px; letter-spacing: 3px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 20px; }
  .reveal-song { font-family: 'Playfair Display', serif; font-size: clamp(32px, 5vw, 60px); font-weight: 900; line-height: 1.05; letter-spacing: -1px; color: var(--text); margin-bottom: 16px; }
  .reveal-artist { font-size: 24px; font-weight: 700; color: var(--reveal-color, var(--amber)); margin-bottom: 8px; }
  .reveal-album { font-size: 15px; color: var(--text-dim); margin-bottom: 32px; }
  .reveal-meta-row { display: flex; gap: 32px; flex-wrap: wrap; margin-bottom: 40px; }
  .reveal-meta-item .reveal-meta-num { font-family: 'Playfair Display', serif; font-size: 36px; font-weight: 900; color: var(--reveal-color, var(--amber)); line-height: 1; }
  .reveal-meta-item .reveal-meta-label { font-size: 10px; letter-spacing: 2px; text-transform: uppercase; color: var(--text-muted); margin-top: 4px; }
  .reveal-actions { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
  .btn-spotify { display: inline-flex; align-items: center; gap: 8px; background: #1DB954; color: #000; font-family: 'Space Mono', monospace; font-size: 13px; font-weight: 700; padding: 14px 28px; text-decoration: none; letter-spacing: 1px; transition: opacity 0.15s; white-space: nowrap; }
  .btn-spotify:hover { opacity: 0.85; }
  .btn-reshuffle { display: inline-flex; align-items: center; gap: 8px; background: transparent; color: var(--text-dim); font-family: 'Space Mono', monospace; font-size: 12px; font-weight: 700; padding: 14px 24px; text-decoration: none; letter-spacing: 1px; border: 1px solid var(--border); cursor: pointer; transition: color 0.15s, border-color 0.15s; }
  .btn-reshuffle:hover { color: var(--reveal-color, var(--amber)); border-color: var(--reveal-color, var(--amber)); }

  /* CONTROLS */
  .controls { max-width: 1200px; margin: 28px auto 0; display: flex; align-items: center; gap: 20px; flex-wrap: wrap; }
  .shuffle-btn { font-family: 'Space Mono', monospace; font-size: 13px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; background: var(--amber); color: var(--bg); border: none; padding: 14px 40px; cursor: pointer; transition: opacity 0.15s, transform 0.1s; }
  .shuffle-btn:hover { opacity: 0.88; }
  .shuffle-btn:active { transform: scale(0.97); }
  .shuffle-btn:disabled { opacity: 0.4; cursor: default; }
  .pool-info { font-size: 11px; color: var(--text-muted); letter-spacing: 1px; }

  /* Reel cards shake during spin */
  @keyframes card-rattle {
    0%,100% { transform: translateX(0) rotate(0); }
    25%      { transform: translateX(-2px) rotate(-0.4deg); }
    75%      { transform: translateX(2px)  rotate(0.4deg); }
  }
  body.is-spinning .reel-card.placeholder { animation: card-rattle 0.1s infinite; }

  @media (max-width: 800px) {
    .reels-row { grid-template-columns: 1fr; gap: 8px; }
    .site-nav { padding: 0 16px; } .nav-link { padding: 8px 8px; font-size: 10px; }
    .page-header { padding: 32px 16px 0; }
    .shuffle-area { padding: 32px 16px 60px; }
    .reel-body { padding: 18px 16px 16px; }
  }
</style>
</head>
<body>
<canvas id="suit-canvas"></canvas>

<nav class="site-nav">
  <a class="site-logo" href="index.html">Daily <span>Jam</span></a>
  <div class="nav-links">
    <a class="nav-link" href="index.html">Home</a>
    <a class="nav-link" href="catalog.html">Catalog</a>
    <a class="nav-link" href="calendar.html">Calendar</a>
    <a class="nav-link" href="stats.html">Stats</a>
    <a class="nav-link active" href="shuffle.html">Shuffle</a>
    <a class="nav-link" href="daily-jam-links.html">Links</a>
  </div>
</nav>

<div class="page-header">
  <h1>Shuffle</h1>
  <p>Roll 3 songs — pick one to play</p>
  <div class="year-filter">
    <button class="yf-btn all active" data-year="0">All Years</button>
    <button class="yf-btn y1" data-year="1">DJ 1</button>
    <button class="yf-btn y2" data-year="2">DJ 2</button>
    <button class="yf-btn y3" data-year="3">DJ 3</button>
    <button class="yf-btn y4" data-year="4">DJ 4</button>
    <button class="yf-btn y5" data-year="5">DJ 5</button>
    <button class="yf-btn y6" data-year="6">DJ 6</button>
    <button class="yf-btn y7" data-year="7">DJ 7</button>
    <button class="yf-btn y8" data-year="8">DJ 8</button>
  </div>
</div>

<div class="shuffle-area">

  <div class="reels-row" id="reels-row">
    <!-- Reel 1 -->
    <div class="reel-card placeholder" id="reel-0">
      <div class="reel-top-bar"></div>
      <div class="reel-body">
        <div class="reel-num">Reel 1</div>
        <div class="reel-window">
          <div class="reel-tape" id="tape-0">
            <div class="reel-tape-item">—</div>
            <div class="reel-tape-item center">Hit Shuffle</div>
            <div class="reel-tape-item">—</div>
          </div>
        </div>
        <div class="reel-artist" id="artist-0">—</div>
        <div class="reel-album"  id="album-0">—</div>
        <div class="reel-footer">
          <div class="reel-meta" id="meta-0">—</div>
          <div class="reel-select-hint" id="hint-0"></div>
        </div>
      </div>
    </div>
    <!-- Reel 2 -->
    <div class="reel-card placeholder" id="reel-1">
      <div class="reel-top-bar"></div>
      <div class="reel-body">
        <div class="reel-num">Reel 2</div>
        <div class="reel-window">
          <div class="reel-tape" id="tape-1">
            <div class="reel-tape-item">—</div>
            <div class="reel-tape-item center">to begin</div>
            <div class="reel-tape-item">—</div>
          </div>
        </div>
        <div class="reel-artist" id="artist-1">—</div>
        <div class="reel-album"  id="album-1">—</div>
        <div class="reel-footer">
          <div class="reel-meta" id="meta-1">—</div>
          <div class="reel-select-hint" id="hint-1"></div>
        </div>
      </div>
    </div>
    <!-- Reel 3 -->
    <div class="reel-card placeholder" id="reel-2">
      <div class="reel-top-bar"></div>
      <div class="reel-body">
        <div class="reel-num">Reel 3</div>
        <div class="reel-window">
          <div class="reel-tape" id="tape-2">
            <div class="reel-tape-item">—</div>
            <div class="reel-tape-item center">↓</div>
            <div class="reel-tape-item">—</div>
          </div>
        </div>
        <div class="reel-artist" id="artist-2">—</div>
        <div class="reel-album"  id="album-2">—</div>
        <div class="reel-footer">
          <div class="reel-meta" id="meta-2">—</div>
          <div class="reel-select-hint" id="hint-2"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Reveal panel (replaces reels after picking) -->
  <div class="reveal-panel" id="reveal-panel">
    <div class="reveal-card" id="reveal-card">
      <div class="reveal-top-bar" id="reveal-top-bar"></div>
      <div class="reveal-body">
        <div class="reveal-eyebrow">Your Pick</div>
        <div class="reveal-song" id="reveal-song-name"></div>
        <div class="reveal-artist" id="reveal-artist"></div>
        <div class="reveal-album" id="reveal-album"></div>
        <div class="reveal-meta-row">
          <div class="reveal-meta-item">
            <div class="reveal-meta-num" id="reveal-day"></div>
            <div class="reveal-meta-label">Day</div>
          </div>
          <div class="reveal-meta-item">
            <div class="reveal-meta-num" id="reveal-date"></div>
            <div class="reveal-meta-label">Date Added</div>
          </div>
          <div class="reveal-meta-item">
            <div class="reveal-meta-num" id="reveal-year-pill"></div>
            <div class="reveal-meta-label">Playlist</div>
          </div>
        </div>
        <div class="reveal-actions">
          <a class="btn-spotify" id="btn-spotify" href="#" target="_blank">▶ Open in Spotify</a>
          <button class="btn-reshuffle" id="btn-back">← Roll Again</button>
        </div>
      </div>
    </div>
  </div>

  <div class="controls" id="controls">
    <button class="shuffle-btn" id="shuffle-btn" disabled>Loading…</button>
    <div class="pool-info" id="pool-info"></div>
  </div>

</div>

<script>
const YEAR_COLORS = ['','#5d8fe8','#5dba7f','#e85d8f','#e8a45d','#a45de8','#5de8e8','#e8e85d','#FF6B6B'];
const YEAR_GLOWS  = ['','rgba(93,143,232,0.15)','rgba(93,186,127,0.15)','rgba(232,93,143,0.15)','rgba(232,164,93,0.15)','rgba(164,93,232,0.15)','rgba(93,232,232,0.15)','rgba(232,232,93,0.15)','rgba(255,107,107,0.15)'];
const YEAR_LABELS = ['','2018–19','2019–20','2020–21','2021–22','2022–23','2023–24','2024–25','2025–26'];

function getDailyJamYear(dayNum) {
  const daysInYears = [365, 366, 365, 365, 365, 366, 365, 365];
  let total = 0;
  for (let i = 0; i < daysInYears.length; i++) {
    total += daysInYears[i];
    if (dayNum <= total) return i + 1;
  }
  return 8;
}

let SONGS = [];
let pool = [];
let filterYear = 0;
let spinning = false;
let finalSongs = [null, null, null];
let selectedReel = -1;

function getPool() {
  return filterYear === 0 ? SONGS : SONGS.filter(s => getDailyJamYear(s[0]) === filterYear);
}

function updatePoolInfo() {
  pool = getPool();
  const label = filterYear === 0 ? 'All Years' : `DJ ${filterYear} (${YEAR_LABELS[filterYear]})`;
  document.getElementById('pool-info').textContent = `${pool.length.toLocaleString()} songs in pool`;
}

// Build a tape of song titles for the scroll animation
function buildTape(songs, centerIndex) {
  // center item is at index 1 in a 3-item tape; build longer tape around it
  const items = [];
  for (let i = -4; i <= 4; i++) {
    const idx = (centerIndex + i + songs.length) % songs.length;
    items.push(songs[idx][2]);
  }
  return items; // 9 items, center is index 4
}

// Animate one reel scrolling: rapidly cycle through songs, then ease into final
function spinReel(reelIndex, songPool, delay, finalSong) {
  return new Promise(resolve => {
    setTimeout(() => {
      const tape = document.getElementById(`tape-${reelIndex}`);
      const card = document.getElementById(`reel-${reelIndex}`);
      const ITEM_H = 50;

      // Generate a long random tape, with finalSong at position -1 from end
      const count = 30 + Math.floor(Math.random() * 10);
      let items = [];
      for (let i = 0; i < count; i++) {
        items.push(songPool[Math.floor(Math.random() * songPool.length)]);
      }
      // Put the final song at position count-2 (so center lands on it)
      items[count - 2] = finalSong;

      // Build DOM
      tape.innerHTML = '';
      items.forEach((s, i) => {
        const div = document.createElement('div');
        div.className = 'reel-tape-item' + (i === count - 2 ? ' center' : '');
        div.textContent = s[2];
        tape.appendChild(div);
      });

      // Start at top
      tape.style.transition = 'none';
      tape.style.transform = 'translateY(0)';

      // The center of the window is at 40px (items 0,1,2 visible; item 1 is center)
      // We want item (count-2) to be in center = offset = (count-2 - 1) * 40 = (count-3)*40
      const targetOffset = (count - 3) * ITEM_H;

      // Animate via requestAnimationFrame with easing — 3 second spin
      const duration = 3000 + delay * 0.5;
      const startTime = performance.now();

      function easeOut(t) {
        return 1 - Math.pow(1 - t, 3);
      }

      function frame(now) {
        const elapsed = now - startTime;
        const t = Math.min(elapsed / duration, 1);
        const eased = easeOut(t);
        const currentY = -(eased * targetOffset);
        tape.style.transform = `translateY(${currentY}px)`;

        if (t < 1) {
          requestAnimationFrame(frame);
        } else {
          tape.style.transform = `translateY(-${targetOffset}px)`;
          // Collapse window to show only center item
          card.querySelector('.reel-window').classList.add('settled');
          // Settle bounce
          card.style.transition = 'transform 0.25s cubic-bezier(.34,1.56,.64,1)';
          card.style.transform = 'translateY(-4px)';
          setTimeout(() => {
            card.style.transform = '';
            resolve();
          }, 250);
        }
      }
      requestAnimationFrame(frame);
    }, delay);
  });
}

function setReelSong(i, song) {
  const yr = getDailyJamYear(song[0]);
  const color = YEAR_COLORS[yr];
  const glow  = YEAR_GLOWS[yr];
  const card  = document.getElementById(`reel-${i}`);

  card.style.setProperty('--reel-color', color);
  card.style.setProperty('--reel-glow', glow);
  card.classList.remove('placeholder');
  card.classList.add('has-song');

  document.getElementById(`artist-${i}`).textContent = song[3];
  document.getElementById(`album-${i}`).textContent  = song[4];
  document.getElementById(`meta-${i}`).textContent   = `Day ${song[0].toLocaleString()} · ${song[5]}`;
  document.getElementById(`hint-${i}`).textContent   = 'Click to pick →';

  // set year pill on top bar (reuse card's top bar color)
  card.querySelector('.reel-top-bar').style.background = color;
}

function showReels() {
  document.getElementById('reels-row').style.display = '';
  document.getElementById('controls').style.display = '';
  document.getElementById('reveal-panel').classList.remove('visible');
}

function clearSelection() {
  for (let i = 0; i < 3; i++) {
    const card = document.getElementById(`reel-${i}`);
    card.classList.remove('selected', 'dimmed');
  }
  showReels();
  selectedReel = -1;
}

function selectReel(i) {
  if (!finalSongs[i]) return;
  selectedReel = i;

  const song = finalSongs[i];
  const yr = getDailyJamYear(song[0]);
  const color = YEAR_COLORS[yr];
  const glow  = YEAR_GLOWS[yr];

  // Hide reels and controls, show reveal
  document.getElementById('reels-row').style.display = 'none';
  document.getElementById('controls').style.display = 'none';

  const panel = document.getElementById('reveal-panel');
  const card  = document.getElementById('reveal-card');
  card.style.setProperty('--reveal-color', color);
  card.style.setProperty('--reveal-glow', glow);
  document.getElementById('reveal-top-bar').style.background = color;
  document.getElementById('reveal-song-name').textContent = song[2];
  document.getElementById('reveal-artist').textContent    = song[3];
  document.getElementById('reveal-artist').style.color   = color;
  document.getElementById('reveal-album').textContent    = song[4];
  document.getElementById('reveal-day').textContent      = song[0].toLocaleString();
  document.getElementById('reveal-day').style.color      = color;
  document.getElementById('reveal-date').textContent     = song[5];
  document.getElementById('reveal-date').style.color     = color;
  document.getElementById('reveal-year-pill').textContent = `DJ ${yr}`;
  document.getElementById('reveal-year-pill').style.color = color;
  document.getElementById('btn-spotify').href = `https://open.spotify.com/track/${song[1]}`;
  panel.classList.add('visible');
}

async function doShuffle() {
  if (spinning || pool.length < 3) return;
  spinning = true;
  clearSelection();
  finalSongs = [null, null, null];
  BG.spinStart();

  const btn = document.getElementById('shuffle-btn');
  btn.disabled = true;
  btn.textContent = 'Spinning…';

  // Pick 3 distinct songs
  const picked = new Set();
  while (picked.size < 3) picked.add(Math.floor(Math.random() * pool.length));
  const picks = [...picked].map(i => pool[i]);
  finalSongs = picks;

  // Reset cards to spinning state
  for (let i = 0; i < 3; i++) {
    const card = document.getElementById(`reel-${i}`);
    card.classList.remove('has-song', 'selected', 'dimmed');
    card.classList.add('placeholder');
    card.style.transform = '';
    card.style.transition = '';
    card.querySelector('.reel-window').classList.remove('settled');
    document.getElementById(`artist-${i}`).textContent = '—';
    document.getElementById(`album-${i}`).textContent  = '—';
    document.getElementById(`meta-${i}`).textContent   = '—';
    document.getElementById(`hint-${i}`).textContent   = '';
  }

  // Spin all 3 reels, staggered by 180ms each
  await Promise.all([
    spinReel(0, pool, 0,   picks[0]),
    spinReel(1, pool, 180, picks[1]),
    spinReel(2, pool, 360, picks[2]),
  ]);

  // After all settled, fill in the details
  BG.spinStop();
  for (let i = 0; i < 3; i++) {
    setReelSong(i, finalSongs[i]);
  }

  spinning = false;
  btn.disabled = false;
  btn.textContent = 'Shuffle Again';
}

// Reel click handlers
for (let i = 0; i < 3; i++) {
  document.getElementById(`reel-${i}`).addEventListener('click', () => {
    if (finalSongs[i]) selectReel(i);
  });
}

document.getElementById('shuffle-btn').addEventListener('click', doShuffle);

// Roll Again — go back to reels and immediately shuffle
document.getElementById('btn-back').addEventListener('click', () => {
  showReels();
  finalSongs = [null, null, null];
  selectedReel = -1;
  doShuffle();
});

document.querySelectorAll('.yf-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    document.querySelectorAll('.yf-btn').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    filterYear = parseInt(this.dataset.year);
    updatePoolInfo();
  });
});

Promise.all([1,2,3,4,5,6,7,8].map(y =>
  fetch(`songs-dj${y}.json`)
    .then(r => r.text())
    .then(txt => { if (txt.charCodeAt(0) === 0xFEFF) txt = txt.slice(1); return JSON.parse(txt); })
))
  .then(arrays => {
    SONGS = arrays.flat();
    updatePoolInfo();
    const btn = document.getElementById('shuffle-btn');
    btn.disabled = false;
    btn.textContent = 'Shuffle';
  });

// ── Neon Music Background ────────────────────────────────────────────────────
// isSpinning = true while reels are rolling → background goes wild
// isSpinning = false → background is calm
const BG = (function() {
  const canvas = document.getElementById('suit-canvas');
  const ctx = canvas.getContext('2d');

  const NEON = [
    [255, 20,  147],
    [0,   255, 255],
    [180, 0,   255],
    [0,   255, 100],
    [255, 200, 0  ],
    [255, 80,  0  ],
  ];
  const NOTES = ['♩','♪','♫','♬'];

  let W, H;
  let isSpinning = false;
  let e = 0; // 0 = calm, 1 = full chaos — lerped smoothly

  // ── Vinyl records ─────────────────────────────────────────────────────────
  let vinyls = [];
  function mkVinyl() {
    const c = NEON[Math.floor(Math.random() * NEON.length)];
    const r = 50 + Math.random() * 90;
    return {
      x: Math.random() * W, y: Math.random() * H, r,
      angle: Math.random() * Math.PI * 2,
      baseRotSpeed: (0.0003 + Math.random() * 0.0004) * (Math.random() < 0.5 ? 1 : -1),
      color: c,
      baseOpacity: 0.08 + Math.random() * 0.12,
      pulsePhase: Math.random() * Math.PI * 2,
      pulseSpeed: 0.0007 + Math.random() * 0.001,
      driftX: (Math.random() - 0.5) * 0.035,
      driftY: (Math.random() - 0.5) * 0.025,
    };
  }
  function drawVinyl(v, now, dt) {
    // At full spin: rotate 6× faster, brighter, bigger glow
    const rotMult = 1 + e * 5;
    v.angle += v.baseRotSpeed * rotMult * dt;
    const pulse = Math.sin(now * v.pulseSpeed * (1 + e) + v.pulsePhase) * (0.03 + e * 0.07);
    const op = Math.max(0, v.baseOpacity + pulse + e * 0.15);
    const [r, g, b] = v.color;
    ctx.save();
    ctx.translate(v.x, v.y);
    ctx.rotate(v.angle);
    const glowR = v.r * (1.3 + e * 0.5);
    const grd = ctx.createRadialGradient(0, 0, v.r * 0.55, 0, 0, glowR);
    grd.addColorStop(0, `rgba(${r},${g},${b},${op * (0.5 + e * 0.5)})`);
    grd.addColorStop(1, `rgba(${r},${g},${b},0)`);
    ctx.beginPath(); ctx.arc(0, 0, glowR, 0, Math.PI*2);
    ctx.fillStyle = grd; ctx.fill();
    const grooves = 7;
    for (let i = grooves; i >= 1; i--) {
      const gr = v.r * 0.28 + v.r * 0.72 * (i / grooves);
      const gop = op * (0.3 + 0.7 * (i / grooves));
      ctx.beginPath(); ctx.arc(0, 0, gr, 0, Math.PI*2);
      ctx.strokeStyle = `rgba(${r},${g},${b},${gop})`;
      ctx.lineWidth = i === grooves ? 2 + e * 2 : 1;
      ctx.shadowColor = `rgba(${r},${g},${b},${gop})`;
      ctx.shadowBlur = (i === grooves ? 10 : 3) + e * 20;
      ctx.stroke();
    }
    ctx.beginPath(); ctx.arc(0, 0, v.r * 0.13, 0, Math.PI*2);
    ctx.fillStyle = `rgba(${r},${g},${b},${Math.min(op * 2, 1)})`;
    ctx.shadowColor = `rgba(${r},${g},${b},0.95)`;
    ctx.shadowBlur = 14 + e * 24;
    ctx.fill();
    ctx.beginPath(); ctx.arc(0, 0, v.r * 0.04, 0, Math.PI*2);
    ctx.fillStyle = 'rgba(5,5,8,0.95)'; ctx.shadowBlur = 0; ctx.fill();
    ctx.restore();
  }

  // ── Music notes ───────────────────────────────────────────────────────────
  let notes = [];
  function mkNote(startY) {
    const c = NEON[Math.floor(Math.random() * NEON.length)];
    return {
      x: Math.random() * W,
      y: startY !== undefined ? startY : H + 60,
      note: NOTES[Math.floor(Math.random() * NOTES.length)],
      size: 16 + Math.random() * 32,
      color: c, opacity: 0,
      maxOpacity: 0.4 + Math.random() * 0.4,
      fadeIn: true,
      baseSpeed: 0.22 + Math.random() * 0.4,
      driftX: (Math.random() - 0.5) * 0.3,
      wobble: Math.random() * Math.PI * 2,
      wobbleSpeed: 0.001 + Math.random() * 0.0015,
      wobbleAmp: 16 + Math.random() * 30,
    };
  }
  function drawNote(n, now) {
    // Speed up and grow during spin
    const speed = n.baseSpeed * (1 + e * 3);
    n.y -= speed;
    ctx.save();
    const wx = n.x + Math.sin(now * n.wobbleSpeed + n.wobble) * n.wobbleAmp * (0.5 + e * 0.5);
    ctx.translate(wx, n.y);
    ctx.font = `${n.size * (1 + e * 0.3)}px serif`;
    ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
    const [r, g, b] = n.color;
    const op = n.opacity * (0.6 + e * 0.4);
    ctx.fillStyle = `rgba(${r},${g},${b},${op})`;
    ctx.shadowColor = `rgba(${r},${g},${b},${op})`;
    ctx.shadowBlur = 12 + e * 28;
    ctx.fillText(n.note, 0, 0);
    ctx.restore();
  }

  // ── Waveform bars ─────────────────────────────────────────────────────────
  let wavePhases = [];
  const WAVE_COUNT = 80;
  function initWave() {
    wavePhases = Array.from({length: WAVE_COUNT}, () => ({
      phase: Math.random() * Math.PI * 2,
      speed: 0.0008 + Math.random() * 0.0015,
      amp:   0.35 + Math.random() * 0.65,
    }));
  }
  function drawWaveform(now) {
    // Calm: short quiet bars. Spinning: tall fast blazing bars.
    const maxH  = 40 + e * 200;
    const speedM = 1 + e * 4;
    const barW   = W / WAVE_COUNT;
    const baseY  = H - 1;
    const hue    = (now * (0.012 + e * 0.06)) % 360;
    for (let i = 0; i < WAVE_COUNT; i++) {
      const wp = wavePhases[i];
      const raw = Math.sin(now * wp.speed * speedM + wp.phase);
      const h   = Math.abs(raw) * maxH * wp.amp;
      const localHue = (hue + i * (360 / WAVE_COUNT)) % 360;
      const op  = (0.08 + e * 0.2) + Math.abs(raw) * (0.2 + e * 0.5);
      const grd = ctx.createLinearGradient(0, baseY, 0, baseY - h);
      grd.addColorStop(0, `hsla(${localHue},100%,60%,${Math.min(op,1)})`);
      grd.addColorStop(1, `hsla(${localHue},100%,90%,${Math.min(op*0.1,1)})`);
      ctx.fillStyle = grd;
      ctx.shadowColor = `hsla(${localHue},100%,70%,${0.3 + e * 0.5})`;
      ctx.shadowBlur = 4 + e * 18;
      ctx.fillRect(i * barW + barW*0.1, baseY - h, barW*0.8, h);
    }
    ctx.shadowBlur = 0;
  }

  // ── Spotlight beams (only appear during spin) ─────────────────────────────
  let beams = [];
  function mkBeam() {
    const c = NEON[Math.floor(Math.random() * NEON.length)];
    return {
      x: 0.1 * W + Math.random() * 0.8 * W,
      sweepAngle: 0,
      sweepSpeed: (0.0005 + Math.random() * 0.0008) * (Math.random()<0.5?1:-1),
      sweepRange: 0.4 + Math.random() * 0.5,
      color: c,
      width: 0.05 + Math.random() * 0.07,
    };
  }
  function drawBeams(now) {
    if (e < 0.05) return;
    beams.forEach(b => {
      b.sweepAngle += b.sweepSpeed * 16;
      const ang = -Math.PI / 2 + Math.sin(b.sweepAngle) * b.sweepRange;
      const [r, g, bl] = b.color;
      const op = e * (0.06 + Math.random() * 0.02);
      const len = Math.sqrt(W*W + H*H);
      const ex = b.x + Math.cos(ang) * len;
      const ey = Math.sin(ang) * len;
      const sx = Math.cos(ang + Math.PI/2) * len * b.width;
      const sy = Math.sin(ang + Math.PI/2) * len * b.width;
      const grd = ctx.createLinearGradient(b.x, H, ex, ey);
      grd.addColorStop(0, `rgba(${r},${g},${bl},${op})`);
      grd.addColorStop(1, `rgba(${r},${g},${bl},0)`);
      ctx.save();
      ctx.beginPath();
      ctx.moveTo(b.x, H);
      ctx.lineTo(ex + sx, ey + sy);
      ctx.lineTo(ex - sx, ey - sy);
      ctx.closePath();
      ctx.fillStyle = grd;
      ctx.fill();
      ctx.restore();
    });
  }

  // ── Init / resize ─────────────────────────────────────────────────────────
  function resize() {
    W = canvas.width  = window.innerWidth;
    H = canvas.height = window.innerHeight;
    initScene();
  }
  function initScene() {
    vinyls = Array.from({length: Math.max(4, Math.round(W/260))}, mkVinyl);
    const nc = Math.max(8, Math.round(W/110));
    notes = Array.from({length: nc}, () => {
      const n = mkNote(Math.random() * H);
      n.opacity = n.maxOpacity * Math.random();
      n.fadeIn = false;
      return n;
    });
    beams = Array.from({length: 6}, mkBeam);
    initWave();
  }

  // ── Main draw loop ────────────────────────────────────────────────────────
  let noteSpawn = 0;
  let lastTime  = 0;
  function draw(now) {
    const dt = Math.min(now - lastTime, 50);
    lastTime = now;

    // Smoothly ramp e toward target (0 = calm, 1 = full chaos)
    const target = isSpinning ? 1 : 0;
    e += (target - e) * (isSpinning ? 0.06 : 0.025); // ramp up fast, calm down slow

    ctx.clearRect(0, 0, W, H);
    drawWaveform(now);
    drawBeams(now);

    vinyls.forEach(v => {
      v.x += v.driftX * dt * (1 + e * 2);
      v.y += v.driftY * dt * (1 + e * 2);
      if (v.x < -v.r*2 || v.x > W+v.r*2) v.driftX *= -1;
      if (v.y < -v.r*2 || v.y > H+v.r*2) v.driftY *= -1;
      drawVinyl(v, now, dt);
    });

    notes.forEach((n, i) => {
      if (n.fadeIn) {
        n.opacity = Math.min(n.opacity + 0.001 * dt, n.maxOpacity);
        if (n.opacity >= n.maxOpacity * 0.95) n.fadeIn = false;
      } else if (n.y < -80) {
        notes[i] = mkNote(H + 40);
      }
      drawNote(n, now);
    });

    // Spawn extra notes while spinning
    noteSpawn += dt;
    const interval = isSpinning ? 150 : 2500;
    if (noteSpawn > interval) {
      noteSpawn = 0;
      notes.push(mkNote());
      const max = isSpinning ? 40 : 14;
      if (notes.length > max) notes.shift();
    }

    requestAnimationFrame(draw);
  }

  // ── Public API ────────────────────────────────────────────────────────────
  function spinStart() { isSpinning = true;  document.body.classList.add('is-spinning'); }
  function spinStop()  { isSpinning = false; document.body.classList.remove('is-spinning'); }

  window.addEventListener('resize', resize);
  resize();
  requestAnimationFrame(draw);
  return { spinStart, spinStop };
})();
</script>
</body>
</html>
