<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Daily Jam ‚Äî Match the Song</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;0,900;1,700&family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0e0c0f; --surface: #161418; --surface2: #1e1b21; --border: #272330;
    --amber: #9b6dff; --amber-glow: rgba(155,109,255,0.12);
    --text: #e8e0d0; --text-dim: #9e9080; --text-muted: #6a6460;
    --green: #5dba7f; --red: #e85d4a;
    --y1:#5d8fe8; --y2:#5dba7f; --y3:#e85d8f; --y4:#e8a45d;
    --y5:#a45de8; --y6:#5de8e8; --y7:#e8e85d; --y8:#FF6B6B;
    --hot-scorch: #ff4400; --hot-warm: #e8a45d; --cold-cold: #5d8fe8; --cold-freeze: #a0d4ff;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: #0a0810; color: var(--text); font-family: 'Space Mono', monospace; min-height: 100vh; overflow-x: hidden; }
  body::before { content: ''; position: fixed; inset: 0; pointer-events: none; z-index: 0;
    background:
      radial-gradient(ellipse 90% 70% at 5%  0%,   rgba(155,109,255,0.38) 0%, transparent 65%),
      radial-gradient(ellipse 70% 60% at 95% 100%,  rgba(93,143,232,0.28)  0%, transparent 60%),
      radial-gradient(ellipse 55% 45% at 88% 5%,    rgba(232,93,143,0.18)  0%, transparent 55%),
      radial-gradient(ellipse 50% 40% at 3%  95%,   rgba(93,186,127,0.18)  0%, transparent 55%); }
  body::after { content: ''; position: fixed; inset: 0; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E"); pointer-events: none; z-index: 9999; opacity: 0.4; }

  /* NAV */
  .site-nav { position: sticky; top: 0; z-index: 100; display: flex; align-items: center; justify-content: space-between; padding: 0 40px; height: 56px; background: rgba(14,12,15,0.95); border-bottom: 1px solid var(--border); backdrop-filter: blur(8px); }
  .site-logo { font-family: 'Space Mono', monospace; font-size: 16px; font-weight: 700; color: var(--text); text-decoration: none; letter-spacing: 1px; }
  .site-logo span { color: var(--amber); font-style: italic; }
  .nav-links { display: flex; gap: 4px; align-items: center; }
  .nav-link { font-size: 11px; letter-spacing: 2px; text-transform: uppercase; color: var(--text-dim); text-decoration: none; padding: 8px 14px; transition: color 0.15s; }
  .nav-link:hover { color: var(--text); }
  .nav-link.active { color: var(--amber); }

  /* GAME LAYOUT */
  .game-wrap { position: relative; z-index: 1; min-height: calc(100vh - 56px); display: flex; flex-direction: column; }

  /* HEADER BAR */
  .game-header { padding: 20px 40px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; gap: 24px; }
  .game-title-row { display: flex; flex-direction: column; gap: 4px; flex-shrink: 0; }
  .game-eyebrow { font-size: 10px; letter-spacing: 3px; text-transform: uppercase; color: var(--y2); }
  .game-title { font-family: 'Playfair Display', serif; font-size: 28px; font-weight: 700; }

  /* PROGRESS */
  .progress-row { display: flex; align-items: center; gap: 16px; flex: 1; justify-content: center; }
  .round-pips { display: flex; gap: 6px; }
  .pip { width: 10px; height: 10px; border: 1px solid var(--border); background: var(--surface2); transition: background 0.2s, border-color 0.2s; }
  .pip.correct { background: var(--green); border-color: var(--green); }
  .pip.close   { background: var(--y4);   border-color: var(--y4); }
  .pip.wrong   { background: var(--red);   border-color: var(--red); }
  .pip.current { border-color: var(--text-dim); }

  /* SCORE */
  .score-display { display: flex; flex-direction: column; align-items: flex-end; gap: 2px; flex-shrink: 0; }
  .score-label { font-size: 10px; letter-spacing: 2px; text-transform: uppercase; color: var(--text-muted); }
  .score-num { font-family: 'Playfair Display', serif; font-size: 36px; font-weight: 900; color: var(--amber); line-height: 1; }

  /* LOADING */
  .loading { display: flex; align-items: center; justify-content: center; flex: 1; font-size: 11px; color: var(--text-muted); letter-spacing: 3px; text-transform: uppercase; }

  /* MAIN GAME AREA */
  .game-body { flex: 1; display: flex; flex-direction: column; padding: 40px; gap: 28px; max-width: 860px; margin: 0 auto; width: 100%; }

  /* SONG DISPLAY */
  .song-card { background: var(--surface); border: 1px solid var(--border); padding: 32px 40px; text-align: center; }
  .song-label { font-size: 10px; letter-spacing: 3px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 14px; }
  .song-title { font-family: 'Playfair Display', serif; font-size: clamp(20px, 3.5vw, 38px); font-weight: 900; line-height: 1.15; color: var(--text); }
  .song-artist { margin-top: 10px; font-size: 15px; color: var(--text-dim); }
  .song-extra { margin-top: 8px; font-size: 12px; color: var(--text-muted); letter-spacing: 1px; min-height: 18px; }

  /* SPOTIFY EMBED */
  .embed-wrap { margin-top: 20px; }
  .embed-frame-wrap { position: relative; overflow: hidden; background: var(--surface2); height: 80px; border: 1px solid var(--border); }
  .embed-frame-wrap iframe { display: block; border: none; }
  .embed-play-cover {
    position: absolute; inset: 0; z-index: 5;
    display: flex; align-items: center; justify-content: center; gap: 12px;
    background: var(--surface2); cursor: pointer; transition: background 0.15s;
  }
  .embed-play-cover:hover { background: var(--surface); }
  .embed-play-cover.hidden { display: none; }
  .epc-circle { width: 36px; height: 36px; border-radius: 50%; background: var(--y2); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
  .epc-triangle { width:0; height:0; border-top:7px solid transparent; border-bottom:7px solid transparent; border-left:12px solid #0a0810; margin-left:2px; }
  .epc-label { font-size: 10px; letter-spacing: 2px; text-transform: uppercase; color: var(--text-muted); }

  /* ‚îÄ‚îÄ LIFELINES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  .lifelines-section { display: flex; flex-direction: column; gap: 12px; }
  .lifelines-header { display: flex; align-items: center; justify-content: space-between; }
  .lifelines-label { font-size: 10px; letter-spacing: 3px; text-transform: uppercase; color: var(--text-muted); }
  .lifelines-note  { font-size: 10px; color: var(--text-muted); letter-spacing: 1px; }

  .lifelines-row { display: flex; gap: 8px; }

  /* each lifeline card */
  .lifeline-card { flex: 1; border: 1px solid var(--border); background: var(--surface); padding: 12px 14px; cursor: pointer; transition: border-color 0.15s, background 0.15s; position: relative; }
  .lifeline-card:hover:not(.used):not(.disabled) { border-color: var(--lc-color, var(--amber)); background: var(--surface2); }
  .lifeline-card.used     { opacity: 0.28; cursor: default; pointer-events: none; }
  .lifeline-card.disabled { opacity: 0.4;  cursor: default; pointer-events: none; }

  .lc-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; }
  .lc-name { font-size: 11px; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase; color: var(--lc-color, var(--amber)); }
  .lc-icon { font-size: 18px; line-height: 1; }
  .lc-desc { font-size: 10px; color: var(--text-dim); line-height: 1.5; letter-spacing: 0.5px; }
  .lc-used-stamp { position: absolute; top: 6px; right: 8px; font-size: 9px; letter-spacing: 1px; text-transform: uppercase; color: var(--text-muted); }

  /* Safety active state */
  .lifeline-card.safety-active { border-color: var(--green) !important; background: rgba(93,186,127,0.07) !important; }
  .lifeline-card.safety-active .lc-name { color: var(--green); }

  /* YEAR GRID */
  .year-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; position: relative; }

  .year-btn {
    font-family: 'Space Mono', monospace; font-size: 13px; font-weight: 700;
    letter-spacing: 1px; padding: 20px 12px;
    border: 2px solid var(--btn-color); color: var(--btn-color);
    background: transparent; cursor: pointer;
    transition: background 0.15s, color 0.15s, transform 0.1s, opacity 0.2s;
    display: flex; flex-direction: column; align-items: center; gap: 4px;
    position: relative; overflow: hidden;
  }
  .year-btn:hover:not(:disabled):not(.eliminated) { background: var(--btn-color); color: #0a0810; }
  .year-btn:active:not(:disabled) { transform: scale(0.97); }
  .year-btn.eliminated { opacity: 0.12; cursor: default; border-style: dashed; pointer-events: none; }
  .year-btn.reveal-correct { background: var(--green) !important; border-color: var(--green) !important; color: #0a0810 !important; }
  .year-btn.wrong-guess    { background: var(--red)   !important; border-color: var(--red)   !important; color: #0a0810 !important; }
  .year-label { font-size: 9px; letter-spacing: 2px; text-transform: uppercase; color: inherit; font-weight: 400; }

  /* Hot/Cold overlay on individual button */
  .year-btn .hc-overlay {
    position: absolute; inset: 0; display: flex; flex-direction: column;
    align-items: center; justify-content: center; gap: 2px;
    font-size: 22px; line-height: 1; pointer-events: none;
    opacity: 0; transition: opacity 0.2s;
  }
  .year-btn.hc-shown .hc-overlay { opacity: 1; }
  .year-btn.hc-shown .yr-main { opacity: 0.15; }
  .hc-label { font-size: 9px; letter-spacing: 1px; text-transform: uppercase; font-weight: 700; }

  /* tier colours */
  .hc-scorching .hc-overlay { background: rgba(255,68,0,0.18); color: #ff6622; }
  .hc-scorching .hc-label   { color: #ff6622; }
  .hc-warm      .hc-overlay { background: rgba(232,164,93,0.18); color: var(--y4); }
  .hc-warm      .hc-label   { color: var(--y4); }
  .hc-cold      .hc-overlay { background: rgba(93,143,232,0.18); color: var(--y1); }
  .hc-cold      .hc-label   { color: var(--y1); }
  .hc-freezing  .hc-overlay { background: rgba(160,212,255,0.18); color: #a0d4ff; }
  .hc-freezing  .hc-label   { color: #a0d4ff; }

  /* HOT/COLD result strip below grid */
  .hc-result { margin-top: 4px; min-height: 28px; text-align: center; font-size: 12px; letter-spacing: 1px; color: var(--text-dim); display: none; }
  .hc-result.visible { display: block; }

  /* SAFETY banner */
  .safety-banner { display: none; background: rgba(93,186,127,0.1); border: 1px solid var(--green); padding: 10px 16px; text-align: center; font-size: 11px; color: var(--green); letter-spacing: 1px; }
  .safety-banner.visible { display: block; }

  /* RESULT AREA */
  .result-area { display: none; background: var(--surface); border: 1px solid var(--border); padding: 24px 32px; text-align: center; }
  .result-area.correct { border-color: var(--green); background: rgba(93,186,127,0.07); }
  .result-area.close   { border-color: var(--y4);    background: rgba(232,164,93,0.07); }
  .result-area.wrong   { border-color: var(--red);   background: rgba(232,93,74,0.07); }
  .result-headline { font-family: 'Playfair Display', serif; font-size: 22px; font-weight: 700; margin-bottom: 6px; }
  .result-area.correct .result-headline { color: var(--green); }
  .result-area.close   .result-headline { color: var(--y4); }
  .result-area.wrong   .result-headline { color: var(--red); }
  .result-detail { font-size: 11px; color: var(--text-dim); letter-spacing: 1px; margin-bottom: 16px; }
  .result-points { font-family: 'Playfair Display', serif; font-size: 40px; font-weight: 900; color: var(--amber); margin-bottom: 4px; }
  .result-points-label { font-size: 10px; letter-spacing: 2px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 20px; }
  .next-btn { font-family: 'Space Mono', monospace; font-size: 10px; letter-spacing: 2px; text-transform: uppercase; padding: 12px 28px; border: 1px solid var(--border); color: var(--text); background: transparent; cursor: pointer; transition: background 0.15s; }
  .next-btn:hover { background: var(--surface2); }

  /* SUMMARY */
  .summary { display: none; flex-direction: column; gap: 0; flex: 1; }
  .summary-header { padding: 40px 40px 24px; border-bottom: 1px solid var(--border); text-align: center; }
  .summary-title { font-family: 'Playfair Display', serif; font-size: 48px; font-weight: 900; }
  .summary-total { font-family: 'Playfair Display', serif; font-size: 80px; font-weight: 900; color: var(--amber); line-height: 1; }
  .summary-total-label { font-size: 11px; letter-spacing: 3px; text-transform: uppercase; color: var(--text-muted); margin-top: 4px; }
  .summary-rows { flex: 1; }
  .summary-row { display: grid; grid-template-columns: 32px 1fr auto auto; align-items: center; gap: 16px; padding: 14px 40px; border-bottom: 1px solid var(--border); }
  .summary-row:hover { background: var(--surface); }
  .summary-rnum { font-size: 10px; color: var(--text-muted); }
  .summary-song { font-size: 12px; }
  .summary-song-title { color: var(--text); }
  .summary-song-artist { font-size: 10px; color: var(--text-dim); margin-top: 2px; }
  .summary-year-pill { font-size: 10px; font-weight: 700; letter-spacing: 1px; padding: 3px 10px; border: 1px solid currentColor; white-space: nowrap; }
  .summary-pts { font-family: 'Playfair Display', serif; font-size: 20px; font-weight: 700; color: var(--amber); text-align: right; min-width: 60px; }
  .summary-pts.zero  { color: var(--red); }
  .summary-pts.close { color: var(--y4); }
  .summary-footer { padding: 32px 40px; border-top: 1px solid var(--border); display: flex; justify-content: center; gap: 16px; }
  .restart-btn { font-family: 'Space Mono', monospace; font-size: 11px; letter-spacing: 2px; text-transform: uppercase; padding: 14px 32px; border: 1px solid var(--amber); color: var(--amber); background: transparent; cursor: pointer; transition: background 0.15s, color 0.15s; }
  .restart-btn:hover { background: var(--amber); color: #0a0810; }
  .hub-btn { font-family: 'Space Mono', monospace; font-size: 11px; letter-spacing: 2px; text-transform: uppercase; padding: 14px 32px; border: 1px solid var(--border); color: var(--text-dim); background: transparent; cursor: pointer; text-decoration: none; display: inline-block; transition: background 0.15s; }
  .hub-btn:hover { background: var(--surface2); color: var(--text); }

  @media (max-width: 900px) {
    .site-nav { padding: 0 16px; }
    .game-header { padding: 16px; flex-wrap: wrap; }
    .game-body { padding: 20px 16px; gap: 20px; }
    .summary-row { padding: 12px 16px; grid-template-columns: 24px 1fr auto auto; gap: 10px; }
    .summary-header { padding: 28px 16px 20px; }
    .summary-footer { padding: 24px 16px; }
  }
  @media (max-width: 640px) {
    .year-grid { grid-template-columns: repeat(2, 1fr); }
    .lifelines-row { flex-direction: column; }
    .round-pips { gap: 4px; }
    .pip { width: 8px; height: 8px; }
    .nav-links .nav-link { padding: 8px 8px; font-size: 10px; }
    .song-card { padding: 24px 16px; }
  }
</style>
</head>
<body>

<nav class="site-nav">
  <a class="site-logo" href="index.html">Daily <span>Jam</span></a>
  <div class="nav-links">
    <a class="nav-link" href="index.html">Home</a>
    <a class="nav-link" href="catalog.html">Catalog</a>
    <a class="nav-link" href="calendar.html">Calendar</a>
    <a class="nav-link" href="stats.html">Stats</a>
    <a class="nav-link" href="shuffle.html">Shuffle</a>
    <a class="nav-link active" href="games.html">Games</a>
    <a class="nav-link" href="daily-jam-links.html">Links</a>
  </div>
</nav>

<div class="game-wrap">

  <div class="game-header">
    <div class="game-title-row">
      <div class="game-eyebrow">Game 02</div>
      <div class="game-title">Match the Song</div>
    </div>
    <div class="progress-row">
      <div class="round-pips" id="pips"></div>
    </div>
    <div class="score-display">
      <div class="score-label">Score</div>
      <div class="score-num" id="score-display">0</div>
    </div>
  </div>

  <div id="loading-state" class="loading">Loading catalog...</div>

  <!-- GAME STATE -->
  <div id="game-state" style="display:none; flex-direction:column; flex:1;">
    <div class="game-body">

      <!-- Song card -->
      <div class="song-card">
        <div class="song-label">Which DJ Year is this song from?</div>
        <div class="song-title" id="song-title">‚Äî</div>
        <div class="song-artist" id="song-artist"></div>
        <div class="song-extra" id="song-extra"></div>
        <div class="embed-wrap">
          <div class="embed-frame-wrap" id="embed-frame-wrap">
            <div class="embed-play-cover" id="embed-play-cover" onclick="revealEmbed()">
              <div class="epc-circle"><div class="epc-triangle"></div></div>
              <span class="epc-label">Preview Song</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Lifelines -->
      <div class="lifelines-section">
        <div class="lifelines-header">
          <span class="lifelines-label">Lifelines ‚Äî one use each per game</span>
          <span class="lifelines-note" id="hints-used-note"></span>
        </div>
        <div class="lifelines-row">

          <!-- Slice -->
          <div class="lifeline-card" id="lc-slice" style="--lc-color:#e85d8f" onclick="useLifeline('slice')">
            <div class="lc-top">
              <span class="lc-name">Slice</span>
              <span class="lc-icon">‚úÇ</span>
            </div>
            <div class="lc-desc">Cuts 4 random wrong answers, leaving just 4 to choose from.</div>
          </div>

          <!-- Safety -->
          <div class="lifeline-card" id="lc-safety" style="--lc-color:#5dba7f" onclick="useLifeline('safety')">
            <div class="lc-top">
              <span class="lc-name">Safety</span>
              <span class="lc-icon">üõ°</span>
            </div>
            <div class="lc-desc">Protects one wrong guess. If you pick wrong it won't count ‚Äî try again.</div>
          </div>

          <!-- Hot/Cold -->
          <div class="lifeline-card" id="lc-hotcold" style="--lc-color:#ff6622" onclick="useLifeline('hotcold')">
            <div class="lc-top">
              <span class="lc-name">Hot / Cold</span>
              <span class="lc-icon">üå°</span>
            </div>
            <div class="lc-desc">Picks a random year and rates it: Scorching üî•, Warm, Cold, or Freezing ‚ùÑ.</div>
          </div>

        </div>
      </div>

      <!-- Safety active banner -->
      <div class="safety-banner" id="safety-banner">üõ° Safety active ‚Äî your next wrong guess won't count</div>

      <!-- Year buttons -->
      <div class="year-grid" id="year-grid"></div>

      <!-- Hot/Cold result strip -->
      <div class="hc-result" id="hc-result"></div>

      <!-- Result area -->
      <div class="result-area" id="result-area">
        <div class="result-headline" id="result-headline"></div>
        <div class="result-detail" id="result-detail"></div>
        <div class="result-points" id="result-points"></div>
        <div class="result-points-label">points</div>
        <button class="next-btn" id="next-btn" onclick="nextRound()">Next Round ‚Üí</button>
      </div>

    </div>
  </div>

  <!-- SUMMARY STATE -->
  <div class="summary" id="summary-state">
    <div class="summary-header">
      <div class="summary-title">Final Score</div>
      <div class="summary-total" id="summary-total">0</div>
      <div class="summary-total-label">out of 10,000 points</div>
    </div>
    <div class="summary-rows" id="summary-rows"></div>
    <div class="summary-footer">
      <a class="hub-btn" href="games.html">‚Üê Back to Games</a>
      <button class="restart-btn" onclick="restartGame()">Play Again</button>
    </div>
  </div>

</div>

<script>
const DJ_YEARS = [
  { num:1, label:'DJ1', color:'#5d8fe8', start:'2018-09-24', end:'2019-09-23' },
  { num:2, label:'DJ2', color:'#5dba7f', start:'2019-09-24', end:'2020-09-23' },
  { num:3, label:'DJ3', color:'#e85d8f', start:'2020-09-24', end:'2021-09-23' },
  { num:4, label:'DJ4', color:'#e8a45d', start:'2021-09-24', end:'2022-09-23' },
  { num:5, label:'DJ5', color:'#a45de8', start:'2022-09-24', end:'2023-09-23' },
  { num:6, label:'DJ6', color:'#5de8e8', start:'2023-09-24', end:'2024-09-23' },
  { num:7, label:'DJ7', color:'#e8e85d', start:'2024-09-24', end:'2025-09-23' },
  { num:8, label:'DJ8', color:'#FF6B6B', start:'2025-09-24', end:'2026-09-23' },
];

const HC_TIERS = [
  { diff:0, cls:'hc-scorching', emoji:'üî•üî•', label:'Scorching', desc:'This IS the year!' },
  { diff:1, cls:'hc-warm',      emoji:'üå§',   label:'Warm',      desc:'One year away' },
  { diff:2, cls:'hc-cold',      emoji:'üå®',   label:'Cold',      desc:'Two years away' },
  { diff:null, cls:'hc-freezing', emoji:'‚ùÑ‚ùÑ', label:'Freezing',  desc:'Way off' },
];

const TOTAL_ROUNDS = 10;
const BASE_POINTS  = 1000;
const HINT_PENALTY = 250;

// ‚îÄ‚îÄ Game state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let allSongsByYear = [];
let rounds = [];
let roundIdx = 0;
let totalScore = 0;
let answered = false;
let eliminated = new Set();
let history = [];

// Per-game lifeline state (reset on startGame, never on nextRound)
let lifelines = { slice: false, safety: false, hotcold: false };
let safetyActive = false;  // safety has been activated and not yet consumed
let hintsUsedThisRound = 0; // tracks how many lifelines used this round for point penalty

// ‚îÄ‚îÄ LOAD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadData() {
  try {
    const arrays = await Promise.all([1,2,3,4,5,6,7,8].map(y =>
      fetch(`songs-dj${y}.json`)
        .then(r => r.text())
        .then(txt => { if (txt.charCodeAt(0) === 0xFEFF) txt = txt.slice(1); return JSON.parse(txt); })
    ));
    allSongsByYear = arrays;
    document.getElementById('loading-state').style.display = 'none';
    startGame();
  } catch(e) {
    document.getElementById('loading-state').textContent = 'Failed to load catalog.';
  }
}

// ‚îÄ‚îÄ START / RESTART ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startGame() {
  rounds = pickRounds();
  roundIdx = 0;
  totalScore = 0;
  history = [];
  lifelines = { slice: false, safety: false, hotcold: false };
  safetyActive = false;
  hintsUsedThisRound = 0;

  document.getElementById('score-display').textContent = '0';
  document.getElementById('summary-state').style.display = 'none';
  document.getElementById('game-state').style.display = 'flex';
  buildPips();
  renderLifelineCards();
  loadRound();
}

function restartGame() { startGame(); }

function pickRounds() {
  const selected = [];
  const used = Array(8).fill(null).map(() => new Set());
  for (let y = 0; y < 8; y++) {
    const pool = allSongsByYear[y];
    const idx  = Math.floor(Math.random() * pool.length);
    used[y].add(idx);
    selected.push({ song: pool[idx], yearNum: y + 1 });
  }
  for (let i = 0; i < 2; i++) {
    let y, idx;
    do { y = Math.floor(Math.random() * 8); idx = Math.floor(Math.random() * allSongsByYear[y].length); }
    while (used[y].has(idx));
    used[y].add(idx);
    selected.push({ song: allSongsByYear[y][idx], yearNum: y + 1 });
  }
  return selected.sort(() => Math.random() - 0.5);
}

// ‚îÄ‚îÄ PIPS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildPips() {
  const c = document.getElementById('pips');
  c.innerHTML = '';
  for (let i = 0; i < TOTAL_ROUNDS; i++) {
    const p = document.createElement('div');
    p.className = 'pip' + (i === 0 ? ' current' : '');
    p.id = `pip-${i}`;
    c.appendChild(p);
  }
}
function updatePip(idx, result) {
  const p = document.getElementById(`pip-${idx}`);
  if (p) p.className = 'pip ' + result;
  const n = document.getElementById(`pip-${idx + 1}`);
  if (n) n.classList.add('current');
}

// ‚îÄ‚îÄ LIFELINE CARDS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderLifelineCards() {
  ['slice','safety','hotcold'].forEach(key => {
    const card = document.getElementById(`lc-${key}`);
    card.classList.toggle('used', lifelines[key]);
    card.classList.remove('disabled');
    // Safety: disable if answered or already consumed this round via safetyActive
    if (key === 'safety' && safetyActive) card.classList.add('disabled');
  });
  // Update safety card style when active
  const sc = document.getElementById('lc-safety');
  sc.classList.toggle('safety-active', safetyActive);
}

// ‚îÄ‚îÄ SPOTIFY EMBED ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadEmbed(trackId) {
  const wrap = document.getElementById('embed-frame-wrap');
  const old  = wrap.querySelector('iframe');
  if (old) old.remove();
  const iframe = document.createElement('iframe');
  iframe.src    = `https://open.spotify.com/embed/track/${trackId}?utm_source=generator&theme=0`;
  iframe.width  = '100%';
  iframe.height = '80';
  iframe.setAttribute('frameborder', '0');
  iframe.setAttribute('allow', 'autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture');
  iframe.setAttribute('loading', 'lazy');
  wrap.insertBefore(iframe, document.getElementById('embed-play-cover'));
}

function revealEmbed() {
  const trackId = rounds[roundIdx].song[1];
  const wrap = document.getElementById('embed-frame-wrap');
  const old  = wrap.querySelector('iframe');
  if (old) old.remove();
  const iframe = document.createElement('iframe');
  iframe.src    = `https://open.spotify.com/embed/track/${trackId}?utm_source=generator&theme=0&autoplay=1`;
  iframe.width  = '100%';
  iframe.height = '80';
  iframe.setAttribute('frameborder', '0');
  iframe.setAttribute('allow', 'autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture');
  wrap.insertBefore(iframe, document.getElementById('embed-play-cover'));
  document.getElementById('embed-play-cover').classList.add('hidden');
}

// ‚îÄ‚îÄ ROUND ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadRound() {
  answered = false;
  eliminated = new Set();
  hintsUsedThisRound = 0;
  safetyActive = lifelines.safety && false; // safety persists as used=true but active resets

  const { song } = rounds[roundIdx];
  document.getElementById('song-title').textContent = song[2];
  document.getElementById('song-artist').textContent = song[3];
  document.getElementById('song-extra').textContent = '';

  // Reset embed
  loadEmbed(song[1]);
  document.getElementById('embed-play-cover').classList.remove('hidden');

  const resultArea = document.getElementById('result-area');
  resultArea.style.display = 'none';
  resultArea.className = 'result-area';

  document.getElementById('hc-result').className = 'hc-result';
  document.getElementById('hc-result').textContent = '';
  document.getElementById('safety-banner').className = 'safety-banner';

  renderLifelineCards();
  buildYearGrid();
}

function buildYearGrid() {
  const grid = document.getElementById('year-grid');
  grid.innerHTML = '';
  DJ_YEARS.forEach(yr => {
    const btn = document.createElement('button');
    btn.className = 'year-btn';
    btn.style.setProperty('--btn-color', yr.color);
    btn.id = `yr-btn-${yr.num}`;
    btn.innerHTML = `
      <span class="yr-main">${yr.label}</span>
      <span class="year-label">Year ${yr.num}</span>
      <div class="hc-overlay"><span class="hc-emoji"></span><span class="hc-label"></span></div>
    `;
    btn.onclick = () => guess(yr.num);
    grid.appendChild(btn);
  });
}

// ‚îÄ‚îÄ LIFELINES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function useLifeline(key) {
  if (lifelines[key]) return; // already used for this game
  if (answered) return;

  const { yearNum: correct } = rounds[roundIdx];

  if (key === 'slice') {
    lifelines.slice = true;
    hintsUsedThisRound++;
    // Eliminate 4 random wrong years ‚Äî always from non-eliminated pool
    const pool = DJ_YEARS.map(y => y.num).filter(y => y !== correct && !eliminated.has(y));
    const toElim = pool.sort(() => Math.random() - 0.5).slice(0, 4);
    toElim.forEach(y => {
      eliminated.add(y);
      const btn = document.getElementById(`yr-btn-${y}`);
      if (btn) { btn.classList.add('eliminated'); btn.disabled = true; }
    });
  }

  else if (key === 'safety') {
    lifelines.safety = true;
    safetyActive = true;
    hintsUsedThisRound++;
    document.getElementById('safety-banner').className = 'safety-banner visible';
  }

  else if (key === 'hotcold') {
    lifelines.hotcold = true;
    hintsUsedThisRound++;
    // Pick a random year from those NOT eliminated (and not already hc-shown)
    const pool = DJ_YEARS.filter(y => !eliminated.has(y.num));
    if (!pool.length) return;
    const picked = pool[Math.floor(Math.random() * pool.length)];
    const diff   = Math.abs(picked.num - correct);

    // Determine tier
    let tier;
    if      (diff === 0) tier = HC_TIERS[0];
    else if (diff === 1) tier = HC_TIERS[1];
    else if (diff === 2) tier = HC_TIERS[2];
    else                 tier = HC_TIERS[3];

    // Apply overlay to that button
    const btn = document.getElementById(`yr-btn-${picked.num}`);
    if (btn) {
      btn.classList.add('hc-shown', tier.cls);
      btn.querySelector('.hc-emoji').textContent = tier.emoji;
      btn.querySelector('.hc-label').textContent = tier.label;
    }

    // Result strip
    const strip = document.getElementById('hc-result');
    strip.textContent = `${picked.label} ‚Üí ${tier.emoji} ${tier.label} ‚Äî ${tier.desc}`;
    strip.className = 'hc-result visible';
  }

  renderLifelineCards();
}

// ‚îÄ‚îÄ SCORING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function calcPoints(correctYearNum, guessedYearNum) {
  const diff = Math.abs(correctYearNum - guessedYearNum);
  let base;
  if      (diff === 0) base = 1000;
  else if (diff === 1) base = 500;
  else if (diff === 2) base = 200;
  else                 base = 0;
  return Math.max(0, base - hintsUsedThisRound * HINT_PENALTY);
}

// ‚îÄ‚îÄ GUESS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function guess(yearNum) {
  if (answered) return;

  const { song, yearNum: correct } = rounds[roundIdx];
  const isCorrect = yearNum === correct;

  // Safety net: wrong guess absorbed
  if (!isCorrect && safetyActive) {
    safetyActive = false;
    document.getElementById('safety-banner').className = 'safety-banner';
    // Flash the wrong button briefly then reset
    const wrongBtn = document.getElementById(`yr-btn-${yearNum}`);
    if (wrongBtn) {
      wrongBtn.classList.add('wrong-guess');
      setTimeout(() => wrongBtn.classList.remove('wrong-guess'), 600);
    }
    renderLifelineCards();
    return; // don't lock in the answer
  }

  answered = true;

  const diff   = Math.abs(correct - yearNum);
  const points = calcPoints(correct, yearNum);
  totalScore  += points;
  history.push({ song, yearNum: correct, guessedYear: yearNum, points });

  document.getElementById('score-display').textContent = totalScore.toLocaleString();

  // Lock all buttons, reveal correct + wrong
  DJ_YEARS.forEach(yr => {
    const btn = document.getElementById(`yr-btn-${yr.num}`);
    if (!btn) return;
    btn.disabled = true;
    btn.onclick  = null;
    if (yr.num === correct)                  btn.classList.add('reveal-correct');
    if (yr.num === yearNum && !isCorrect)    btn.classList.add('wrong-guess');
  });

  // Result area
  const resultArea  = document.getElementById('result-area');
  const correctYr   = DJ_YEARS.find(y => y.num === correct);
  const guessedYr   = DJ_YEARS.find(y => y.num === yearNum);
  const isClose     = !isCorrect && points > 0;
  const resultClass = isCorrect ? 'correct' : (isClose ? 'close' : 'wrong');

  resultArea.className = 'result-area ' + resultClass;
  document.getElementById('result-headline').textContent =
    isCorrect ? 'Correct!' : (isClose ? 'Close!' : 'Wrong!');

  let detail = '';
  if (isCorrect) {
    detail = `"${song[2]}" is from ${correctYr.label}.`;
    if (hintsUsedThisRound > 0) detail += ` (${hintsUsedThisRound} lifeline${hintsUsedThisRound > 1 ? 's' : ''} used)`;
  } else if (isClose) {
    detail = `That was ${correctYr.label} ‚Äî you were ${diff} year${diff === 1 ? '' : 's'} off.`;
  } else {
    detail = `That was ${correctYr.label}, not ${guessedYr.label}.`;
  }

  document.getElementById('result-detail').textContent = detail;
  document.getElementById('result-points').textContent = `+${points.toLocaleString()}`;

  updatePip(roundIdx, isCorrect ? 'correct' : (isClose ? 'close' : 'wrong'));

  document.getElementById('next-btn').textContent =
    roundIdx === TOTAL_ROUNDS - 1 ? 'See Results ‚Üí' : 'Next Round ‚Üí';

  resultArea.style.display = 'block';
}

// ‚îÄ‚îÄ NEXT / SUMMARY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function nextRound() {
  roundIdx++;
  if (roundIdx >= TOTAL_ROUNDS) showSummary();
  else loadRound();
}

function showSummary() {
  document.getElementById('game-state').style.display = 'none';
  document.getElementById('summary-total').textContent = totalScore.toLocaleString();

  const rowsEl = document.getElementById('summary-rows');
  rowsEl.innerHTML = '';
  history.forEach((h, i) => {
    const yr  = DJ_YEARS.find(y => y.num === h.yearNum);
    const row = document.createElement('div');
    row.className = 'summary-row';
    const ptsClass = h.points === 0 ? 'zero' : (h.yearNum !== h.guessedYear && h.points > 0 ? 'close' : '');
    row.innerHTML = `
      <div class="summary-rnum">${i + 1}</div>
      <div class="summary-song">
        <div class="summary-song-title">${h.song[2]}</div>
        <div class="summary-song-artist">${h.song[3]}</div>
      </div>
      <div class="summary-year-pill" style="color:${yr.color}; border-color:${yr.color}">${yr.label}</div>
      <div class="summary-pts ${ptsClass}">+${h.points.toLocaleString()}</div>
    `;
    rowsEl.appendChild(row);
  });

  document.getElementById('summary-state').style.display = 'flex';
}

loadData();
</script>
</body>
</html>
